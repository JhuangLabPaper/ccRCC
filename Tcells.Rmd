---
title: Integration of multiple experiments for the ccRCC project
author: 
- name: Nick Borcherding
  email: ncborch@gmail.com
  affiliation: Washington University in St. Louis, School of Medicine, St. Louis, MO, USA
date: "June 25, 2020"
output:
  BiocStyle::html_document:
    toc_float: true

---

```{r, echo=FALSE, results="hide", message=FALSE}
knitr::opts_chunk$set(error=FALSE, message=FALSE, warning=FALSE)
library(BiocStyle)
```


# Preperation

## Loading Libaries

In general I like to load libraries here that we will use universally, and then call other libraries when we need them in the code chunks that are relevant. 

```{r}
suppressPackageStartupMessages(library(Seurat))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(dplyr))
```

## Loading Data

```{r}
integrated <- readRDS("./data/Processed/integrated_Cluster.rds")
load("./data/Processed/completeMeta.rda")
```

## Selecting Color Palette

```{r setup, include=FALSE}
colorblind_vector <- colorRampPalette(c("#FF4B20", "#FFB433", "#C6FDEC", "#7AC5FF", "#0348A6"))
```

***

# Initial Subsetting and Analysis

```{r}
Tcells <- subset(integrated, Major == "T.Cell")
Tcells <- NormalizeData(Tcells)
rm(integrated)
```

We are also going to create a subdirectory for all T cell analyses:
```{r}
dir.create("./DataAnalysis/CellType/")
dir.create("./DataAnalysis/CellType/Tcells")
```


## Cell Cycle 

Cell cycle regression as described in the [Satija lab website](https://satijalab.org/seurat/v3.1/cell_cycle_vignette.html).  

```{r}
cc.genes <- Seurat::cc.genes.updated.2019
s.genes <- cc.genes$s.genes
g2m.genes <- cc.genes$g2m.genes
```

Now we can perform cell cycle scoring with the genes. For now, I am not going to regress using the assingments or save the integrated object with the calculations.

```{r}
Tcells <- CellCycleScoring(Tcells, s.features = s.genes, g2m.features = g2m.genes, set.ident = FALSE)
```

Like above with the contribution by condition (**type**), we can now look at the phases assignments by cluster and condition. We do not need to scale if we seperate **type** into seperate bar graphs.

```{r}
dir.create("./DataAnalysis/CellType/Tcells/CellCycle")
freq_table <- Tcells[[]]
freq_table <- freq_table[,c("type", "Final_clusters", "Phase")]
freq_table <- subset(freq_table, Phase != "Undecided") #removing undecided phases
freq_table <- freq_table %>%
    group_by(type, Final_clusters, Phase) %>%
    summarise(n = n())

freq_table$Phase <- factor(freq_table$Phase, levels = c("G1", "S", "G2M")) #ordering phases
freq_table$Final_clusters <- factor(freq_table$Final_clusters, levels = c(1,2,3,8,12,13,14,17,18,21,23,24))

ggplot(freq_table, aes(x=Final_clusters, y=n, fill=Phase)) + 
  geom_bar(stat="identity", position="fill", color="black", lwd=0.25) + 
  theme(axis.title.x = element_blank())+ 
    facet_grid(type ~.) + 
   scale_fill_manual(values=colorblind_vector(3)) + 
  theme_classic()
ggsave(path = "./DataAnalysis/CellType/Tcells/CellCycle", file = "CellCycle_byCluster_byType.pdf", height=6, width=6)

ggplot(freq_table, aes(x=Final_clusters, y=n, fill=Phase)) + 
  stat_summary(geom="bar", position="fill", color="black", lwd=0.25) + 
  theme(axis.title.x = element_blank())+ 
   scale_fill_manual(values=colorblind_vector(3)) + 
  theme_classic()
ggsave(path = "./DataAnalysis/CellType/Tcells/CellCycle", file = "CellCycle_byCluster.pdf", height=2, width=6)
```


```{r}
Tcells$Phase <- factor(Tcells$Phase, levels = c("G1", "S", "G2M")) #ordering phases
DimPlot(object = Tcells, reduction = 'umap', group.by = "Phase", split.by = "type") +
    scale_color_manual(values=colorblind_vector(3)) 


ggsave(path = "./DataAnalysis/CellType/Tcells/CellCycle", filename="CellCycle_UMAP_byType.eps", width=10.5, height=3)
```

## Reclustering 

Isolating just the T cells, stripping the seurat object of non-"RNA" values using *DietSeurat()* and then spliting the object to create a list that can be fed into **SCTransform()**
```{r eval=FALSE}
Tcells@meta.data$Run <- paste0(Tcells@meta.data$sample, "_", Tcells@meta.data$type) #Define the sequence run
Tcells[["percent.mt"]] <- PercentageFeatureSet(Tcells, pattern = "^MT-") #Calculate %mito

Tcells <- DietSeurat(Tcells, assays = "RNA")
T.list <- SplitObject(object = Tcells , split.by = "Run")

for (i in 1:length(T.list)) {
    T.list[[i]] <- SCTransform(T.list[[i]], verbose = FALSE, vars.to.regress = c('nFeature_RNA', 'nCount_RNA', "percent.mt"), conserve.memory=TRUE)
}
rm(Tcells)
```

Integrating the data as above with the whole data set.
```{r eval = FALSE}
options(future.globals.maxSize= 2621440000)
features <- SelectIntegrationFeatures(object.list = T.list, nfeatures = 3000)
T.list <- PrepSCTIntegration(object.list = T.list, anchor.features = features,
verbose = FALSE)
T.anchors <- FindIntegrationAnchors(object.list = T.list, normalization.method = "SCT",
anchor.features = features, verbose = FALSE, k.filter = 100)
Tcells <- IntegrateData(anchorset = T.anchors, normalization.method = "SCT", verbose = FALSE)
rm(T.list)
rm(T.anchors)
saveRDS(Tcells, file = "./data/Processed/Tcells_Precluster.rds")
```

Now we can process the intgreated T cells and identify clusters.
```{r eval = FALSE}
Tcells <- readRDS("./data/Processed/Tcells_Precluster.rds")


dir.create("./DataAnalysis/CellType/Tcells/DimensionInputs")
for (i in c(10,15,20,25,30,35,40)) {
    
    integrated2 <- ScaleData(object = Tcells, verbose = FALSE)
    integrated2 <- RunPCA(object = integrated2, npcs = 40, verbose = FALSE)
    integrated2 <- RunUMAP(object = integrated2, reduction = "pca", 
        dims = 1:i) #dimensions for  UMAP
    for (x in c(10,15,20,25,30,35,40)) { #Dimensions for neighbors
       integrated2 <- FindNeighbors(object = integrated2, dims = 1:x)
       for(y in c(0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1)) { #Resolution
           integrated2 <- FindClusters(object = integrated2, resolution = y, force.recalc=T)
           plot1 <- DimPlot(integrated2, reduction = "umap", pt.size = 0.5, group.by = "orig.ident")
           ggsave(path = "./DataAnalysis/CellType/Tcells/DimensionInputs", file = paste("UMAP", i, "_Neighbors", x, "_resolution", y, "_OrigIdent.pdf", sep=""), plot1, width=4.25, height=3)
           plot2 <- DimPlot(object = integrated2, reduction = 'umap', label = T) + NoLegend()
            ggsave(path = "./DataAnalysis/CellType/Tcells/DimensionInputs", file = paste("UMAP", i, "_Neighbors", x, "_resolution", y, "_clusters.pdf", sep=""), plot2, width=3.5, height=3)
       }
    }
}
rm(integrated2)

```


```{r}
DimPlot(object = Tcells, reduction = 'umap', label = T, ) + NoLegend()
#ggsave(path = "DataAnalysis/UMAP", filename="IntegratedObject_byCluster.eps", width=3.5, height=3)
DimPlot(object = Tcells, reduction = 'umap', group.by = "cloneType") 
#ggsave(path = "DataAnalysis/UMAP", filename="IntegratedObject_byOrig.Ident.eps", width=3.75, height=3)

DefaultAssay(integrated2) <- "RNA"
FeaturePlot(object = integrated2, features = c("CD8A", "CD4")) 
```

```{r}
Tcells <- readRDS("DataAnalysis/subCluster/Tcells/Tcells_integrated.rds")
```
